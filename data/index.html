<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>ESP8266 Tomato Clock</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
}
.container {
  width: 1000px;
  margin: 0 auto;
  text-align: center;
}
.header {
  display: flex;
  justify-content: space-around;
  background: tomato;
  border-radius: 20px 20px 0 0;
}
.card {
  width: 240px;
  border-radius: 5px;
  margin: 30px 0;
  background: white;
  display: flex;
  flex-direction: column;
}
.card-title {
  font-size: 18pt;
  margin: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid gray;
}
.card-content {
  font-size: 22pt;
  font-family: monospace;
  margin-top: 5px;
}
.card-footer {
  font-size: 10pt;
  margin-top: 20px;
}
.card-button {
  width: 240px;
  height: 30px;
  cursor: pointer;
  text-align: center;
  border-radius: 0 0 5px 5px;
}
.center-text {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}
.card-button:hover {
  background: whitesmoke;
}
.working-status {
  color: lightgreen;
}
.resting-status {
  color: coral;
}
.stopped-status {
  color: royalblue;
}
.unknown-status {
  color: gray;
}
.hidden {
  display: none;
}
#main {
  position: relative;
  background: linen;
  min-height: 300px;
  border-radius: 0 0 20px 20px;
}
#main-label {
  position: absolute;
  left: 95px;
  top: 30px;
  font-size: 20px;
}
#chart {
  position: absolute;
  left: 95px;
  top: 80px;
  width: 810px;
  height: 150px;
  background: white;
  border-radius: 20px 20px 0 0;
}
#division {
  position: relative;
  height: 120px;
  border-radius: 20px 20px 0 0;
}
#division span {
  margin-top: 5px;
}
#working-part {
  position: absolute;
  top: 0;
  left: 0;
  border-radius: 20px 0 0 0;
  background-color: lightgreen;
  height: 120px;
  width: 675px;
}
#resting-part {
  position: absolute;
  top: 0;
  left: 675px;
  border-radius: 0 20px 0 0;
  background-color: coral;
  height: 120px;
  width: 135px;
}
#progress {
  background-color: royalblue;
  height: 30px;
  width: 405px;
}
#logs {
  background: honeydew;
  min-height: 300px;
  border-radius: 0 0 20px 20px;
}
</style>
</head>
<body>
  <div class="container">
    <h1>ESP8266 Tomato Clock</h1>
    <div class="header">
      <div class="card">
        <div class="card-title">Time</div>
        <div class="card-content"><span id="current-time">Syncing...<span></div>
        <div class="card-footer"><span id="current-date"><span></div>
      </div>
      <div class="card">
        <div class="card-title">Status</div>
        <div class="card-content"><span id="current-status" class="unknown-status">Unknown<span></div>
        <div class="card-footer"><div class="card-button center-text" id="main-button">▼</div></div>
      </div>
      <div class="card">
        <div class="card-title">Finished</div>
        <div class="card-content"><span id="finished-tomatoes">-<span></div>
        <div class="card-footer"><div class="card-button center-text" id="logs-button">▼</div></div>
      </div>
    </div>
    <div id="main">
      <div id="chart">
        <div id="division">
          <div class="center-text" id="working-part">
            <span>Working time</span>
            <span id="working-time">-</span>
          </div>
          <div class="center-text" id="resting-part">
            <span>Resting time</span>
            <span id="resting-time">-</span>
          </div>
        </div>
        <div id="progress"></div>
      </div>
      <div id="main-label">Remaining cycles: -</div>
    </div>
    <div id="logs" class="hidden">
    </div>
  </div>
  <script>
const current_time = document.getElementById('current-time');
const current_date = document.getElementById('current-date');
const current_status = document.getElementById('current-status');
const finished_tomatoes = document.getElementById('finished-tomatoes');
const main_area = document.getElementById('main');
const main_button = document.getElementById('main-button');
const logs_area = document.getElementById('logs');
const logs_button = document.getElementById('logs-button');

let system_time = Date.now();
let system_logs = {};

const display_system_time = () => {
  const display_time = (t) => {
    const h = `${t.getHours()}`.padStart(2, '0');
    const m = `${t.getMinutes()}`.padStart(2, '0');
    const s = `${t.getSeconds()}`.padStart(2, '0');
    current_time.innerText = `${h}:${m}:${s}`;
  };
  const display_date = (t) => {
    const y = `${t.getFullYear()}`;
    const m = `${t.getMonth() + 1}`.padStart(2, '0');
    const d = `${t.getDate()}`.padStart(2, '0');
    const wd = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][t.getDay()];
    current_date.innerText = `${y}-${m}-${d} ${wd}`;
  };
  const t = new Date(system_time);
  display_time(t);
  display_date(t);
};

const display_statistics = () => {
  const rests = system_logs.filter((rec) => rec.action == "clockStartResting");
  const stops = system_logs.filter((rec) => rec.action == "clockStop");
  finished_tomatoes.innerText = Math.max(rests.length, stops.length);
};

const display_logs_by_date = () => {
};

const fetch_system_time = async () => {
  const res = await fetch('/getTimeNow');
  if (!res.ok) {
    system_time = Date.now();
    display_system_time();
    return;
  }
  const data = await res.json();
  if (!data.now) {
    system_time = Date.now();
  }
  system_time = data.now * 1000;
  display_system_time();
};

const fetch_tomato_status = async () => {
  const res = await fetch('/getStatus');
  let state = 'Unknown';
  if (res.ok) {
    state = await res.text() || 'Unknown';
  }
  current_status.innerText = state;
  if (state == 'Working') {
    current_status.className = 'working-status';
  } else if (state == 'Resting') {
    current_status.className = 'resting-status';
  } else if (state == 'Stopped') {
    current_status.className = 'stopped-status';
  } else {
    current_status.className = 'unknown-status';
  }
};

const fetch_system_logs = async () => {
  const res = await fetch('/logs.json');
  if (!res.ok) {
    return;
  }
  system_logs = await res.json();
  display_statistics();
  display_logs_by_date();
};

window.onload = () => {
  // switch tabs
  main_button.addEventListener('click', () => {
    main_area.className = '';
    logs_area.className = 'hidden';
  });
  logs_button.addEventListener('click', () => {
    main_area.className = 'hidden';
    logs_area.className = '';
  });
};
let short_poll;
let long_poll;
window.onfocus = () => {
  // init
  fetch_system_time();
  fetch_tomato_status();
  fetch_system_logs();

  // timer
  short_poll = setInterval(() => {
    system_time += 1000;
    display_system_time();
    fetch_tomato_status();
  }, 1000);
  long_poll = setInterval(() => {
    fetch_system_time();
    fetch_system_logs();
  }, 10000);
};
window.onblur = () => {
  clearInterval(short_poll);
  clearInterval(long_poll);
};
  </script>
</body>
</html>
